#!/bin/sh

#################################
# Playlist generator and player #
#################################

config="$HOME/.musicrc"
playlist="$HOME/.music-playlist"

# disable globbing because the configuration may contains wildcards
set -f

if [ -n "$1" ]; then
  folder=$(realpath -q "$1")

  if ! (jshon < "$config" > /dev/null); then
    echo "invalid configuration in '$config'"
    exit 2
  fi

  excl_opts=()
  for pattern in $(jshon -e exclude -a -u < "$config"); do
    [ -z "$excl_opts" ] || excl_opts=(${excl_opts[@]} '-and')
    excl_opts=(${excl_opts[@]} '-not' '-iregex' "^.*$pattern.*$")
  done

  match_opts=()
  for ext in $(jshon -e match_extensions -a -u < "$config"); do
    [ -z "$match_opts" ] || match_opts=(${match_opts[@]} '-or')
    match_opts=(${match_opts[@]} '-iregex' ".*\.$ext$")
  done

  find_opts=('-type' 'f' ${excl_opts[@]} ${match_opts[@]})
  find "$folder" -regextype posix-extended ${find_opts[@]} > "$playlist"

  printf "Found %'d song(s) in '%s'" $(wc -l < "$playlist") "$folder"
  echo -e "\n"
fi

if [ ! -s $playlist ]; then
  echo "The playlist was not generated or is empty."
  echo
  echo "To (re)generate the playlist, run:"
  echo "  music Directory/"
  exit 1
fi

mpv --shuffle --loop=inf --no-video --playlist "$playlist"
exit 0
